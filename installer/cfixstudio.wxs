<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2003/01/wi">
  <Product
			Id="$(var.ProductCode)"
			Name="cfix studio"
			Language="1033"
			Version="$(var.ProductVersion)"
			UpgradeCode="e62e11e1-3058-42cd-b855-e0a3743b380a"
			Manufacturer="Johannes Passing">
    <Package
			Id="$(var.PackageCode)"
			Description="VisualSudio addin for cfix"
			InstallerVersion="200"
			Compressed="yes"
			Platforms="Intel"/>

    <Upgrade Id="e62e11e1-3058-42cd-b855-e0a3743b380a">
      <!-- Prevent over-installing newer versions -->
      <UpgradeVersion MigrateFeatures='yes' Minimum="$(var.ProductVersion)" Property="NEWERPRODUCTFOUND" OnlyDetect="yes" IncludeMinimum="no" />
      <Property Id="NEWERPRODUCTFOUND" Secure="yes" />

      <!-- Upgrade older versions -->
      <UpgradeVersion MigrateFeatures='yes' Minimum="1.0.0.0" Maximum="$(var.ProductVersion)" Property="PREVIOUSVERSIONSINSTALLED" IncludeMaximum="yes" />
      <Property Id="PREVIOUSVERSIONSINSTALLED" Secure="yes" />
    </Upgrade>

    <CustomAction Id="ERRCA_CANCELNEWERVERSION" Return="check" Error="$(loc.NewerVersionInstalled)" />
    <InstallExecuteSequence>
      <RemoveExistingProducts After="InstallInitialize" />
      <Custom Action="ERRCA_CANCELNEWERVERSION" After="FindRelatedProducts"><![CDATA[NEWERPRODUCTFOUND AND NOT Installed]]></Custom>

      <Custom Action='UninstallAddinVs80' After='RemoveFiles'><![CDATA[ REMOVE="ALL" AND VS80INSTALLED ]]></Custom>
      <Custom Action='UninstallAddinVs90' After='RemoveFiles'><![CDATA[ REMOVE="ALL" AND VS90INSTALLED ]]></Custom>
    </InstallExecuteSequence>

    <Media Id="1" Cabinet="cfixstudio.cab" EmbedCab="yes" />

    <!-- Retain install location on upgrade -->
    <Property Id="INSTALLLOCATION" Secure="yes">
      <RegistrySearch Id="SearchInstallLocation" Root="HKLM" Key="Software\cfix\cfixstudio\1.0" Name="InstallLocation" Type="directory" />
    </Property>

    
    <!-- Search VS installations -->
    <Property Id="VS80INSTALLED" Secure="yes">
      <RegistrySearch Id="SearchVs80" Root="HKCR" Key="VisualStudio.DTE.8.0" Type="raw" />
    </Property>

    <Property Id="VS80INSTALLDIR" Secure="yes">
      <RegistrySearch Id="SearchVs80InstallDir" Root="HKLM" Key="Software\Microsoft\VisualStudio\8.0" Name="InstallDir" Type="directory" />
    </Property>

    
    <Property Id="VS90INSTALLED" Secure="yes">
      <RegistrySearch Id="SearchVs90" Root="HKCR" Key="VisualStudio.DTE.9.0" Type="raw" />
    </Property>

    <Property Id="VS90INSTALLDIR" Secure="yes">
      <RegistrySearch Id="SearchVs90InstallDir" Root="HKLM" Key="Software\Microsoft\VisualStudio\9.0" Name="InstallDir" Type="directory" />
    </Property>

    

    <Condition Message='Windows 2000 SP4 or better required'>
      <![CDATA[ VersionNT >= 501 OR (VersionNT=500 AND ServicePackLevel>=4) ]]>
    </Condition>

    <Condition Message='Neither a Visual Studio 2005 nor a Visual Studio 2008 installation could be located on your computer. One of these versions is required for cfix studio.'>
      <![CDATA[ VS80INSTALLED OR VS90INSTALLED ]]>
    </Condition>


    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramMenuFolder">
        <Directory Id="DirProgMenu" Name="cfix">
        </Directory>
      </Directory>

      <Directory Id="CommonAppDataFolder">
        <Directory Id="DirAppDataMs80" Name="Microsft" LongName="Microsoft">
          <Directory Id="DirAppDataMsVs80" Name="VisualSt" LongName="VisualStudio">
            <Directory Id="DirAppDataMsVs8080" Name="80" LongName="8.0">
              <Directory Id="DirAppDataMsVs80Addins80" Name="Addins">
                <Component Id="CompVs80" Guid="71f3193d-ba2e-4293-a44c-b1bf868f80ef">
                  <File Id="FileVs80Addin" Name="CfixAddn.Add" LongName="Cfix.Addin.Addin" Source="..\src\Cfix.Addin\Cfix.Addin\Cfix.Addin.Addin.template" DiskId="1"/>
                  <XmlFile 
                    Id="XmlConfigAssemblyVs80" 
                    Action="setValue" 
                    File="[DirAppDataMsVs80Addins80]\Cfix.Addin.Addin" 
                    ElementPath="//Extensibility/Addin/Assembly"
                    Value="[DirBinI386]cfix.addin.dll"/>
                  <XmlFile
                    Id="XmlConfigVersionVs80"
                    Action="setValue"
                    File="[DirAppDataMsVs80Addins80]\Cfix.Addin.Addin"
                    ElementPath="//Extensibility/HostApplication/Version"
                    Value="8.0"/>
                  </Component>
              </Directory>
            </Directory>
          </Directory>
        </Directory>

        <Directory Id="DirAppDataMs90" Name="Microsft" LongName="Microsoft">
          <Directory Id="DirAppDataMsVs90" Name="VisualSt" LongName="VisualStudio">
            <Directory Id="DirAppDataMsVs9090" Name="90" LongName="9.0">
              <Directory Id="DirAppDataMsVs90Addins90" Name="Addins">
                <Component Id="CompVs90" Guid="ab230fe7-5107-45d7-b636-e1f8442622ea">
                  <File Id="FileVs90Addin" Name="CfixAddn.Add" LongName="Cfix.Addin.Addin" Source="..\src\Cfix.Addin\Cfix.Addin\Cfix.Addin.Addin.template" DiskId="1"/>
                  <XmlFile
                    Id="XmlConfigAssemblyVs90"
                    Action="setValue"
                    File="[DirAppDataMsVs90Addins90]\Cfix.Addin.Addin"
                    ElementPath="//Extensibility/Addin/Assembly"
                    Value="[DirBinI386]cfix.addin.dll"/>
                  <XmlFile
                    Id="XmlConfigVersionVs90"
                    Action="setValue"
                    File="[DirAppDataMsVs90Addins90]\Cfix.Addin.Addin"
                    ElementPath="//Extensibility/HostApplication/Version"
                    Value="9.0"/>
                </Component>
              </Directory>
            </Directory>
          </Directory>
        </Directory>
      </Directory>
      
      <Directory Id="ProgramFilesFolder">
        <Directory Id="INSTALLLOCATION" Name="cfixstud" LongName="cfixstudio">
          <Component Id="CompInstallLocation" Guid="e4c7733d-ea7d-4e47-9a53-9dd483092bdc">
            <Registry Id="KeyInstallLocation" Root="HKLM" Key="Software\cfix\cfixstudio\1.0" Name="InstallLocation" Type="string" KeyPath="yes" Value="[INSTALLLOCATION]" />
          </Component>

          <Component Id="CompStdole" Guid="579ce302-450f-4192-82c0-3289c8829c4a">
            <File Id="FileStdoleDll" Name="stdole.dll" KeyPath="yes" Source="redist\stdole.dll" DiskId="1" Assembly=".net"/>
          </Component>

          <Directory Id="DirBin" Name="bin">
            <Directory Id="DirBinI386" Name="i386">
              <Component Id="CompBinI386" Guid="872969e6-2ddc-4306-ac71-5f14c0773614">
                <?include cfix_bin_i386.wxs?>
                <RemoveFolder Id="RemoveDirBinI386" On="uninstall"/>

                <File Id="FileCfixctDllI386" Name="cfixctl.dll" KeyPath="yes" Source="bin\fre\i386\cfixctl.dll" DiskId="1">
                  <?include cfixctl-comreg.wxs?>
                </File>
                <File Id="FileCfixhsExeI386" Name="cfixhs32.exe" Source="bin\fre\i386\cfixhs32.exe" DiskId="1"/>

                <File Id="FileInteropCfixctlI386" Name="cfintero.dll" LongName="interop.cfixctl.dll" Source="bin\fre\i386\interop.cfixctl.dll" DiskId="1"/>
                <File Id="FileCfixControlDllI386" Name="cfcontr.dll" LongName="cfix.control.dll" Source="bin\fre\i386\cfix.control.dll" DiskId="1"/>
                <File Id="FileCfixControlUiDllI386" Name="cfcontui.dll" LongName="cfix.control.ui.dll" Source="bin\fre\i386\cfix.control.ui.dll" DiskId="1"/>
                <File Id="FileCfixControlTreeViewDllI386" Name="cfconttv.dll" LongName="cfix.control.treeview.dll" Source="bin\fre\i386\cfix.control.treeview.dll" DiskId="1"/>
                <File Id="FileCfixAddinDllI386" Name="cfaddin.dll" LongName="cfix.addin.dll" Source="bin\fre\i386\cfix.addin.dll" DiskId="1"/>
              </Component>
            </Directory>

            <Directory Id="DirBinAmd64" Name="amd64">
              <Component Id="CompBinAmd64" Guid="f65055f8-2e34-4b4c-aaeb-1519ee606bfa" Win64="yes">
                <?include cfix_bin_amd64.wxs?>
                <RemoveFolder Id="RemoveDirBinAmd64" On="uninstall"/>

                <File Id="FileCfixctAmd64" Name="cfixctl.dll" KeyPath="yes" Source="bin\fre\amd64\cfixctl.dll" DiskId="1">
                  <?include cfixctl-comreg.wxs?>
                </File>
                <File Id="FileCfixhsExeAmd64" Name="cfixhs64.exe" Source="bin\fre\amd64\cfixhs64.exe" DiskId="1"/>

              </Component>
            </Directory>
          </Directory>

          <Directory Id="DirInclude" Name="include">
            <Component Id="CompIncludes" DiskId="1" Guid="916f5c8b-64a5-4aaa-9e41-3dc890a4d454">
              <?include cfix_include.wxs?>
              <?include cfix_include_winunit.wxs?>
              <RemoveFolder Id="RemoveDirInclude" On="uninstall"/>
            </Component>
          </Directory>

          <Directory Id="DirLib" Name="lib">
            <Directory Id="DirLibI386" Name="i386">
              <Component Id="CompLibI386" DiskId="1" Guid="b2a9d73f-a3fc-462f-b4e8-a4c1506be0fa">
                <?include cfix_lib_i386.wxs?>
                <RemoveFolder Id="RemoveDirLibI386" On="uninstall"/>
              </Component>
            </Directory>
            <Directory Id="DirLibAmd64" Name="amd64">
              <Component Id="CompLibAmd64" DiskId="1" Guid="8b1d09b5-4b0f-46d9-b44a-c3abbd3ffb2a">
                <?include cfix_lib_amd64.wxs?>
                <RemoveFolder Id="RemoveDirLibAmd64" On="uninstall"/>
              </Component>
            </Directory>
          </Directory>

          <Directory Id="DirDoc" Name="doc">
            <Component Id="CompDoc" DiskId="1" Guid="8cadd6d3-5a46-420f-bedb-c7ba2832735b">
              <File Id="FileCfixChm" Name="cfix.chm" Source="$(var.CFIX_TREE)\doc\docbook\cfix.chm" Vital="yes">
                <Shortcut
									Id="ShortcutCfixChm"
									Description="cfix studio Documentation"
									Directory="DirProgMenu"
									Icon="CfixIco"
									Name="Doc"
									LongName="cfix Documentation"/>
              </File>
              <RemoveFolder Id="RemoveDirDoc" On="uninstall"/>
            </Component>
          </Directory>
        </Directory>
      </Directory>
    </Directory>

    <Feature Id="FeatureMain" Title="cfix studio" Absent='disallow' Level="1" AllowAdvertise="no" Display="expand">
      <ComponentRef Id="CompInstallLocation"/>

      <Feature Id="FeatureBinAmd64"
               Absent="allow"
               Title="AMD64 (x64) binaries" 
               Level="1" 
               AllowAdvertise="no" 
               Description="Binaries for AMD64 (x64). Required if you intend to write tests for this platform.">
        <Condition Level="2"><![CDATA[NOT VersionNT64]]></Condition>

        <ComponentRef Id="CompBinAmd64"/>
        <ComponentRef Id="CompLibAmd64"/>
      </Feature>

      <Feature Id="FeatureVs80"
               Absent="allow"
               Title="Visual Studio 2005 integration"
               Level="1"
               AllowAdvertise="no"
               Description="Installs the cfix studio addin for Visual Studio 2005.">
        <Condition Level="0"><![CDATA[NOT VS80INSTALLED]]></Condition>

        <ComponentRef Id="CompVs80"/>
      </Feature>

      <Feature Id="FeatureVs90"
               Absent="allow"
               Title="Visual Studio 2008 integration"
               Level="1"
               AllowAdvertise="no"
               Description="Installs the cfix studio addin for Visual Studio 2008.">
        <Condition Level="0"><![CDATA[NOT VS90INSTALLED]]></Condition>

        <ComponentRef Id="CompVs90"/>
      </Feature>

      <ComponentRef Id="CompStdole"/>
      <ComponentRef Id="CompBinI386"/>
      <ComponentRef Id="CompLibI386"/>
      
      <ComponentRef Id="CompDoc"/>
      <ComponentRef Id="CompIncludes"/>
    </Feature>

    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLLOCATION" />
    <UIRef Id="CfixUi" />

    <Property Id='ALLUSERS'>1</Property>
    
    <Property Id='ARPHELPLINK'>http://www.cfix-studio.com/</Property>
    <Property Id='ARPURLINFOABOUT'>http://www.cfix-studio.com/</Property>
    <Property Id='ARPPRODUCTICON'>CfixIco</Property>

    <Property Id='OPENTUTORIALAFTERFINISH'>1</Property>

    <Property Id='HTMLHELP'>hh.exe</Property>
    <CustomAction Id="LaunchFile" Return="asyncNoWait" Property="HTMLHELP" ExeCommand="mk:@MSITStore:[INSTALLLOCATION]doc\cfix.chm::ch04s01.html" />

    <Property Id='VS80DEVENV'>[VS80INSTALLDIR]devenv.exe</Property>
    <CustomAction Id="UninstallAddinVs80" Execute="commit" Return="ignore" Impersonate="yes" Property="VS80DEVENV" ExeCommand="/ResetAddin Cfix.Addin.CfixPlus /Command File.Exit" />

    <Property Id='VS90DEVENV'>[VS90INSTALLDIR]devenv.exe</Property>
    <CustomAction Id="UninstallAddinVs90" Execute="commit" Return="ignore" Impersonate="yes" Property="VS80DEVENV" ExeCommand="/ResetAddin Cfix.Addin.CfixPlus /Command File.Exit" />

    <Icon Id="CfixIco" SourceFile="icon.ico" />
  </Product>
</Wix>
